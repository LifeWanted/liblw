load("@rules_foreign_cc//tools/build_defs:make.bzl", "make")

package(
  default_visibility = [
    "//lw:__subpackages__",
    "//tools:__subpackages__",
  ],
)

make(
  name = "botan",
  lib_source = "@botan//:all",
  make_commands = [
    "python configure.py " +
      "--prefix=$INSTALLDIR " +
      "--without-documentation " +
      "--without-os-features=sockets " +
      "--without-os-features=threads " +
      "--disable-shared-library " +
      "--with-build-dir=$EXT_BUILD_ROOT/external/botan " +
      "--no-install-python-module " +
      "--build-targets=static",

    "make -j8 -C $EXT_BUILD_ROOT/external/botan",

    "make -C $EXT_BUILD_ROOT/external/botan install PREFIX=$INSTALLDIR",

    "mv $INSTALLDIR/include/botan-2/botan $INSTALLDIR/include/botan",

    "rm -r $INSTALLDIR/include/botan-2",
  ],
  static_libraries = ["libbotan-2.a"],
)

make(
  name = "openssl",
  lib_source = "@openssl//:all",
  make_commands = [
    "cd $EXT_BUILD_ROOT/external/openssl",
    "./Configure " +
      "no-buildtest-c++ no-deprecated no-des no-external-tests no-legacy " +
      "no-makedepend no-md2 no-md4 no-shared no-tests no-ui-console " +
      "no-unit-test no-weak-ssl-ciphers no-zlib " +
      "--prefix=$INSTALLDIR",

    "make -j",

    "make -j install PREFIX=$INSTALLDIR",
  ],
  static_libraries = ["libcrypto.a", "libssl.a"],
)
